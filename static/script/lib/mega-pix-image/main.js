!function(){function t(t){var e=t.naturalWidth,a=t.naturalHeight;if(e*a>1048576){var r=document.createElement("canvas");r.width=r.height=1;var i=r.getContext("2d");return i.drawImage(t,-e+1,0),0===i.getImageData(0,0,1,1).data[3]}return!1}function e(t,e,a){var r=document.createElement("canvas");r.width=1,r.height=a;var i=r.getContext("2d");i.drawImage(t,0,0);for(var n=i.getImageData(0,0,1,a).data,o=0,c=a,h=a;h>o;){var s=n[4*(h-1)+3];0===s?c=h:o=h,h=c+o>>1}var d=h/a;return 0===d?1:d}function a(t,e,a){var i=document.createElement("canvas");return r(t,i,e,a),i.toDataURL("image/jpeg",e.quality||.8)}function r(a,r,i,o){var c=a.naturalWidth,h=a.naturalHeight;if(c+h){var s=i.width,d=i.height,l=r.getContext("2d");l.save(),n(r,l,s,d,i.orientation);var g=t(a);g&&(c/=2,h/=2);var u=1024,v=document.createElement("canvas");v.width=v.height=u;for(var m=v.getContext("2d"),f=o?e(a,c,h):1,w=Math.ceil(u*s/c),b=Math.ceil(u*d/h/f),L=0,I=0;h>L;){for(var R=0,U=0;c>R;)m.clearRect(0,0,u,u),m.drawImage(a,-R,-L),l.drawImage(v,0,0,u,u,U,I,w,b),R+=u,U+=w;L+=u,I+=b}l.restore(),v=m=null}}function i(a,r,i){var n=a.naturalWidth,o=a.naturalHeight;if(n+o){var c=i.width,h=i.height,s=t(a);s&&(n/=2,o/=2);var d=1024,l=document.createElement("canvas");l.width=l.height=d;for(var g=l.getContext("2d"),u=i.doSquash?e(a,n,o):1,v=Math.ceil(d*c/n),m=Math.ceil(d*h/o/u),f=0,w=i.y||0;o>f;){for(var b=0,L=i.x||0;n>b;)g.clearRect(0,0,d,d),g.drawImage(a,-b,-f),r.drawImage(l,0,0,d,d,L,w,v,m),b+=d,L+=v;f+=d,w+=m}l=g=null}}function n(t,e,a,r,i){switch(i){case 5:case 6:case 7:case 8:t.width=r,t.height=a;break;default:t.width=a,t.height=r}switch(i){case 2:e.translate(a,0),e.scale(-1,1);break;case 3:e.translate(a,r),e.rotate(Math.PI);break;case 4:e.translate(0,r),e.scale(1,-1);break;case 5:e.rotate(.5*Math.PI),e.scale(1,-1);break;case 6:e.rotate(.5*Math.PI),e.translate(0,-r);break;case 7:e.rotate(.5*Math.PI),e.translate(a,-r),e.scale(-1,1);break;case 8:e.rotate(-.5*Math.PI),e.translate(-a,0)}}function o(t){if(window.Blob&&t instanceof Blob){if(!c)throw Error("No createObjectURL function found to create blob url");var e=new Image;e.src=c.createObjectURL(t),this.blob=t,t=e}if(!t.naturalWidth&&!t.naturalHeight){var a=this;t.onload=t.onerror=function(){var t=a.imageLoadListeners;if(t){a.imageLoadListeners=null;for(var e=0,r=t.length;r>e;e++)t[e]()}},this.imageLoadListeners=[]}this.srcImage=t}var c=window.URL&&window.URL.createObjectURL?window.URL:window.webkitURL&&window.webkitURL.createObjectURL?window.webkitURL:null;o.renderImageToCanvasContext=i,o.prototype.render=function(t,e,i){if(this.imageLoadListeners){var n=this;return void this.imageLoadListeners.push(function(){n.render(t,e,i)})}e=e||{};var o=this.srcImage.naturalWidth,h=this.srcImage.naturalHeight,s=e.width,d=e.height,l=e.maxWidth,g=e.maxHeight,u=!this.blob||"image/jpeg"===this.blob.type;s&&!d?d=h*s/o<<0:d&&!s?s=o*d/h<<0:(s=o,d=h),l&&s>l&&(s=l,d=h*s/o<<0),g&&d>g&&(d=g,s=o*d/h<<0);var v={width:s,height:d};for(var m in e)v[m]=e[m];var f=t.tagName.toLowerCase();"img"===f?t.src=a(this.srcImage,v,u):"canvas"===f&&r(this.srcImage,t,v,u),"function"==typeof this.onrender&&this.onrender(t),i&&i(),this.blob&&(this.blob=null,c.revokeObjectURL(this.srcImage.src))},"function"==typeof define&&define.amd?define([],function(){return o}):this.MegaPixImage=o}();